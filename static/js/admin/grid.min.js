/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define(["jquery-nos"],function(a){return function(D){D=a.extend({form_id:"",tpvar_id:""},D);var d;var z;var l;var y=1;var p;var s;var c;var n;var t;var v;var A;var m;var u;var B;var e;var o;var g;var r;var q;d=12;z=12;l=new Array(d);y=1;p=new Array(1);function k(){var G="";for(var F=0;F<d;F++){for(var E=0;E<z;E++){G+=l[F][E]+" "}G=G.substr(0,G.length-1);G+="|"}G=G.substr(0,G.length-1);a('[name="wysiwyg_layout"]').attr("value",G)}for(var x=0;x<d;x++){l[x]=new Array(z)}for(var x=0;x<d;x++){for(var w=0;w<z;w++){l[x][w]=0}}for(var x=0;x<d;x++){a("#div_grid").prepend("<div id='div_l"+x+"' class='row'></div>");for(var w=0;w<z;w++){a("#div_l"+x).append("<div id='div_l"+x+"_c"+w+"' class='cell'></div>")}}var h=a('[name="wysiwyg_layout"]').val();C(h);a(".grid_pattern").click(function(){C(a(this).find('input[type="hidden"]').val())});a(document).keypress(function(i){if(i.keyCode==46){a("button[id='btn_suppr']").trigger("click")}});a("button[id='btn_vider']").click(function(){for(var i=0;i<d;i++){for(var j=0;j<z;j++){l[i][j]=0}}a(".cell_new").remove()});a("button[id='btn_suppr']").click(function(){var i=a(".selected");s=a(i).css("top");c=a(i).css("left");n=(parseInt(s)-4)/48;t=(parseInt(c)-4)/48;o=((parseInt(a(i).css("height"))-40)/48)+1;g=((parseInt(a(i).css("width"))-40)/48)+1;for(var j=n;j<o+n;j++){for(var E=t;E<g+t;E++){l[j][E]=0}}a(".selected").remove()});a(".template-e-block-grid").on("dragstart",".cell_new",function(j,i){s=a(this).css("top");c=a(this).css("left");a(this).trigger("click")});a(".template-e-block-grid").on("dragstop",".cell_new",function(E,F){var H=false;v=(parseInt(a(this).css("top"))-4)/48;A=(parseInt(a(this).css("left"))-4)/48;n=(parseInt(s)-4)/48;t=(parseInt(c)-4)/48;r=((parseInt(a(this).css("height"))-40)/48)+1;q=((parseInt(a(this).css("width"))-40)/48)+1;H:for(var i=v;i<r+v;i++){for(var j=A;j<q+A;j++){if(l[i][j]!=0&&l[i][j]!=a(this).attr("data-new")){H=true;break H}}}if(H){a(this).draggable("disable");var G=a(this);a(this).animate({top:s,left:c},200,function(){a(this).draggable("enable")})}else{if(w!=t||x!=n){for(var i=n;i<r+n;i++){for(var j=t;j<q+t;j++){l[i][j]=0}}}for(var i=v;i<r+v;i++){for(var j=A;j<q+A;j++){l[i][j]=a(this).attr("data-new")}}}});a(".template-e-block-grid").on("resizestart",".cell_new",function(j,i){m=a(this).css("height");u=a(this).css("width");a(this).trigger("click")});a(".template-e-block-grid").on("resizestop",".cell_new",function(F,E){var G=false;v=(parseInt(a(this).css("top"))-4)/48;A=(parseInt(a(this).css("left"))-4)/48;B=a(this).css("height");e=a(this).css("width");o=((parseInt(m)-40)/48)+1;g=((parseInt(u)-40)/48)+1;r=((parseInt(B)-40)/48)+1;q=((parseInt(e)-40)/48)+1;G:for(var i=v;i<v+r;i++){for(var j=A;j<A+q;j++){if(l[i][j]!=0&&l[i][j]!=a(this).attr("data-new")){G=true;break G}}}if(G){a(this).animate({width:u,height:m},200)}else{for(var i=v;i<v+o;i++){for(var j=A;j<A+g;j++){l[i][j]=0}}for(var i=v;i<v+r;i++){for(var j=A;j<A+q;j++){l[i][j]=a(this).attr("data-new")}}}});a(".template-e-block-grid").on("click","#btn_ajout",function(G){buckle:for(var F=0;F<d;F++){for(var E=0;E<z;E++){if(l[F][E]==0){l[F][E]=""+y;s=(4+(F)*48);c=(4+(E)*48);a(".selected").removeClass("selected");a("#div_grid").append('<div class="cell_new selected" data-new ="'+y+'" style="top :'+s+"px ;left :"+c+'px"></div>');y++;break buckle}}}G.stopPropagation();f()});a(".template-e-block-grid").on("dragstop resizestop click",".cell_new",function(j,i){k()});a(".template-e-block-grid").on("click","#btn_ajout , #btn_suppr , #btn_vider",function(){k()});function b(i){i=i.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return"#"+("0"+parseInt(i[1],10).toString(16)).slice(-2)+("0"+parseInt(i[2],10).toString(16)).slice(-2)+("0"+parseInt(i[3],10).toString(16)).slice(-2)}function C(K){var E;a(".cell_new").remove();if(K==""){E=new Array(d);for(var H=0;H<d;H++){E[H]=new Array(z)}for(var H=0;H<d;H++){for(var G=0;G<z;G++){E[H][G]=0}}}else{E=K.split("|");for(var H=0;H<E.length;H++){E[H]=E[H].split(" ")}}l=E;var N=new Array();for(var H=0;H<12;H++){for(var G=0;G<12;G++){if(l[H][G]!=0&&a.inArray(l[H][G],N)==-1){var L=H;var J=G;var I=0;var M=0;var F=l[H][G];N.push(F);while(L+I<12&&l[L+I][J]==F){I++}while(J+M<12&&l[L][J+M]==F){M++}a("#div_grid").append('<div class="cell_new " data-new ="'+F+'" style="top :'+(4+L*48)+"px ;left :"+(4+J*48)+"px ; width :"+(40+((M-1)*48))+"px ; height :"+(40+((I-1)*48))+'px"></div>');y=parseInt(F)+1}}}f();a(".cell_new:first").trigger("resizestop")}function f(){a(".template-e-block-grid").on("click",".cell_new",function(i){a(".selected").removeClass("selected");a(this).addClass("selected");a("#btn_suppr").prop("disabled",false);i.stopPropagation()});a(document).click(function(i){a(".selected").removeClass("selected");a("#btn_suppr").prop("disabled",true)});a(".cell_new").draggable({containment:"#div_grid",grid:[48,48]});a(".cell_new").resizable({containment:"#div_grid",grid:[48,48]})}}});