/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define(["jquery-nos"],function(a){return function(E){E=a.extend({form_id:"",tpvar_id:""},E);var q;var s;var g;var z=1;var m;var y=0;var p;var c;var k;var r;var u;var B;var h;var t;var C;var d;var l;var f;var o;var n;q=12;s=12;g=new Array(q);z=1;m=new Array(1);function A(){var F="";for(var H=0;H<q;H++){for(var G=0;G<s;G++){F+=g[H][G]+" "}F=F.substr(0,F.length-1);F+="|"}F=F.substr(0,F.length-1);a('[name="wysiwyg_layout"]').attr("value",F)}for(var x=0;x<q;x++){g[x]=new Array(s)}for(var x=0;x<q;x++){for(var w=0;w<s;w++){g[x][w]=0}}for(var x=0;x<q;x++){a("#div_grid").prepend("<div id='div_l"+x+"' class='row'></div>");for(var w=0;w<s;w++){a("#div_l"+x).append("<div id='div_l"+x+"_c"+w+"' class='cell'></div>")}}var v=a('[name="wysiwyg_layout"]').val();D(v);a(".grid_pattern").click(function(){D(a(this).find('input[type="hidden"]').val())});a(document).keypress(function(i){if(i.keyCode==46){a("button[id='btn_suppr']").trigger("click")}});a("button[id='btn_vider']").click(function(){for(var i=0;i<q;i++){for(var j=0;j<s;j++){g[i][j]=0}}a(".cell_new").remove()});a("button[id='btn_suppr']").click(function(){var i=a(".selected");p=a(i).css("top");c=a(i).css("left");k=(parseInt(p)-4)/48;r=(parseInt(c)-4)/48;l=((parseInt(a(i).css("height"))-40)/48)+1;f=((parseInt(a(i).css("width"))-40)/48)+1;for(var j=k;j<l+k;j++){for(var F=r;F<f+r;F++){g[j][F]=0}}a(".selected").remove()});a(".template-e-block-grid").on("dragstart",".cell_new",function(j,i){p=a(this).css("top");c=a(this).css("left");a(this).trigger("click")});a(".template-e-block-grid").on("dragstop",".cell_new",function(F,G){var I=false;u=(parseInt(a(this).css("top"))-4)/48;B=(parseInt(a(this).css("left"))-4)/48;k=(parseInt(p)-4)/48;r=(parseInt(c)-4)/48;o=((parseInt(a(this).css("height"))-40)/48)+1;n=((parseInt(a(this).css("width"))-40)/48)+1;I:for(var i=u;i<o+u;i++){for(var j=B;j<n+B;j++){if(g[i][j]!=0&&g[i][j]!=a(this).attr("data-new")){I=true;break I}}}if(I){a(this).draggable("disable");var H=a(this);a(this).animate({top:p,left:c},200,function(){a(this).draggable("enable")})}else{if(w!=r||x!=k){for(var i=k;i<o+k;i++){for(var j=r;j<n+r;j++){g[i][j]=0}}}for(var i=u;i<o+u;i++){for(var j=B;j<n+B;j++){g[i][j]=a(this).attr("data-new")}}}});a(".template-e-block-grid").on("resizestart",".cell_new",function(j,i){h=a(this).css("height");t=a(this).css("width");a(this).trigger("click")});a(".template-e-block-grid").on("resizestop",".cell_new",function(G,F){var H=false;u=(parseInt(a(this).css("top"))-4)/48;B=(parseInt(a(this).css("left"))-4)/48;C=a(this).css("height");d=a(this).css("width");l=((parseInt(h)-40)/48)+1;f=((parseInt(t)-40)/48)+1;o=((parseInt(C)-40)/48)+1;n=((parseInt(d)-40)/48)+1;H:for(var i=u;i<u+o;i++){for(var j=B;j<B+n;j++){if(g[i][j]!=0&&g[i][j]!=a(this).attr("data-new")){H=true;break H}}}if(H){a(this).animate({width:t,height:h},200)}else{for(var i=u;i<u+l;i++){for(var j=B;j<B+f;j++){g[i][j]=0}}for(var i=u;i<u+o;i++){for(var j=B;j<B+n;j++){g[i][j]=a(this).attr("data-new")}}}});a(".template-e-block-grid").on("click","#btn_ajout",function(H){boucle:for(var G=0;G<q;G++){for(var F=0;F<s;F++){if(g[G][F]==0){g[G][F]=""+z;p=(4+(G)*48);c=(4+(F)*48);a(".selected").removeClass("selected");a("#div_grid").append('<div class="cell_new selected" data-new ="'+z+'" style="top :'+p+"px ;left :"+c+'px"></div>');z++;break boucle}}}H.stopPropagation();e()});a(".template-e-block-grid").on("dragstop resizestop click",".cell_new",function(j,i){A()});a(".template-e-block-grid").on("click","#btn_ajout , #btn_suppr , #btn_vider",function(){A()});function b(i){i=i.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return"#"+("0"+parseInt(i[1],10).toString(16)).slice(-2)+("0"+parseInt(i[2],10).toString(16)).slice(-2)+("0"+parseInt(i[3],10).toString(16)).slice(-2)}function D(L){var F;a(".cell_new").remove();if(L==""){F=new Array(q);for(var I=0;I<q;I++){F[I]=new Array(s)}for(var I=0;I<q;I++){for(var H=0;H<s;H++){F[I][H]=0}}}else{F=L.split("|");for(var I=0;I<F.length;I++){F[I]=F[I].split(" ")}}g=F;var O=new Array();for(var I=0;I<12;I++){for(var H=0;H<12;H++){if(g[I][H]!=0&&a.inArray(g[I][H],O)==-1){var M=I;var K=H;var J=0;var N=0;var G=g[I][H];O.push(G);while(M+J<12&&g[M+J][K]==G){J++}while(K+N<12&&g[M][K+N]==G){N++}a("#div_grid").append('<div class="cell_new " data-new ="'+G+'" style="top :'+(4+M*48)+"px ;left :"+(4+K*48)+"px ; width :"+(40+((N-1)*48))+"px ; height :"+(40+((J-1)*48))+'px"></div>');z=parseInt(G)+1}}}e();a(".cell_new:first").trigger("resizestop")}function e(){a(".template-e-block-grid").on("click",".cell_new",function(i){a(".selected").removeClass("selected");a(this).addClass("selected");a("#btn_suppr").prop("disabled",false);i.stopPropagation()});a(document).click(function(i){a(".selected").removeClass("selected");a("#btn_suppr").prop("disabled",true)});a(".cell_new").draggable({containment:"#div_grid",grid:[48,48]});a(".cell_new").resizable({containment:"#div_grid",grid:[48,48]})}}});